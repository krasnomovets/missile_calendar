<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Missile Attack Calendar</title>
  
  <!-- Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.8/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    .calendar-container {
      max-width: 600px;
      margin: 0 auto;
      background-color: #f5f5f5;  /* Light grey background to match article */
      padding: 16px;
      height: auto;
      min-height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    /* Ensure the grid takes full height */
    .months-grid {
      display: grid;
      gap: 32px;
      grid-template-columns: repeat(4, 1fr);
      flex: 1;
      height: auto;
    }
    
    /* Adjust mobile breakpoint to ensure all content is visible */
    @media (max-width: 400px) {
      .months-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;  /* Slightly reduced gap for mobile */
      }
      
      /* Additional bottom padding to prevent cutoff */
      .calendar-container {
        padding-bottom: 5px;
      }
    }

    .month {
      display: flex;
      flex-direction: column;
    }

    .month-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
    }

    .weekdays-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      margin-bottom: 6px;
    }

    .weekday-label {
      font-size: 10px;
      color: #999;
      text-align: center;
    }

    .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .day-square {
      aspect-ratio: 1;
    }

    .day-content {
      width: 100%;
      height: 100%;
      background-color: #f5f5f5;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      color: #666;
    }

      .calendar-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      padding: 10px;
    }
    
    .filter-select {
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      background: white;
    }
    
    .range-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #666;
    }
    
    .gradient-bar {
      width: 100px;
      height: 8px;
      background: linear-gradient(to right, #fff5f5, #dc2626);
      border-radius: 4px;
    }
    .error {
      color: #dc2626;
      text-align: center;
      padding: 2rem;
    }
  </style>
</head>
<body>
  <div id="missile-calendar"></div>

  <script type="text/babel">
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vREloeCErwvCs6uJ4RlQGtstC7vPd8u9qlsvE0j7a3Y83JoK7yE_5vMLx4VcdAsRQ_AVfXglj7NXU0c/pub?gid=243376231&single=true&output=csv';
    const CalendarHeatmap = () => {
      const [windowWidth, setWindowWidth] = React.useState(window.innerWidth);
      const [data, setData] = React.useState(null);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [filterType, setFilterType] = React.useState('Missile');
      
      // Handle window resize
      React.useEffect(() => {
        const handleResize = () => setWindowWidth(window.innerWidth);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      // function to get max value based on filter type
      const getMaxValue = (data) => {
      if (!data) return 122; // default max for missiles
  
      if (filterType === 'Combined') {
    // Group by date and sum launched values
        const dailySums = {};
    data.forEach(attack => {
        if (!dailySums[attack.date]) {
        dailySums[attack.date] = 0;
      }
      dailySums[attack.date] += attack.launched;
    });
      return Math.max(...Object.values(dailySums));
  } else {
    // Filter by type and get max
    const filteredData = data.filter(attack => attack.type === filterType);
    return Math.max(...filteredData.map(d => d.launched));
  }
};
      // Fetch data from Google Sheets
React.useEffect(() => {
  const fetchData = async () => {
    try {
      setLoading(true);
      // Log the URL we're trying to fetch
      console.log('Fetching from:', SHEET_URL);
      
      const response = await fetch(SHEET_URL);
      // Log response status
      console.log('Response status:', response.status);
      
      const csvText = await response.text();
      // Log first few characters of CSV
      console.log('CSV preview:', csvText.slice(0, 100));
      
      Papa.parse(csvText, {
  header: true,
  dynamicTyping: true,
  complete: (results) => {
    // Transform data into required format, including date conversion
    const attacks = results.data
      .filter(row => row.date)
      .map(row => {
        // Convert MM/DD/YYYY to YYYY-MM-DD
        const [month, day, year] = row.date.split('/');
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        
        return {
          date: formattedDate,
          launched: row.launched,
          type: row.attack_type
        };
      });
    
    setData(attacks);
    setLoading(false);
  },
        error: (error) => {
          console.error('CSV parsing error:', error);
          throw new Error('Failed to parse CSV: ' + error.message);
        }
      });
    } catch (err) {
      console.error('Fetch error:', err);
      setError('Failed to load data. Please try again later.');
      setLoading(false);
    }
  };

  fetchData();
}, []);

      if (loading) {
        return <div className="loading">Loading calendar data...</div>;
      }

      if (error) {
        return <div className="error">{error}</div>;
      }

      const monthsPerRow = windowWidth < 400 ? 3 : 4;

      const getIntensity = (value) => {
      const maxValue = getMaxValue(data);
      return Math.min((value / maxValue) * 100, 100);
      };

      // function to get data for a specific day
      const getDayData = (dateStr) => {
        if (!data) return null;
        
        const dayAttacks = data.filter(d => d.date === dateStr);
        
        if (filterType === 'Combined') {
          if (dayAttacks.length === 0) return null;
          return {
            date: dateStr,
            launched: dayAttacks.reduce((sum, attack) => sum + attack.launched, 0),
            type: 'Combined'
          };
        } else {
          return dayAttacks.find(d => d.type === filterType);
        }
      };

      const monthNames = ['jan', 'feb', 'mar', 'apr', 'mai', 'jun', 
                         'jul', 'aug', 'sep', 'okt', 'nov', 'des'];
      const weekDays = ['M', 'T', 'O', 'T', 'F', 'L', 'S'];

     return (
        <div className="calendar-container">
          <div className="calendar-header">
            <select 
              value={filterType}
              onChange={(e) => setFilterType(e.target.value)}
              className="filter-select"
            >
              <option value="Missile">Missile</option>
              <option value="Shahed">Shahed</option>
              <option value="Combined">Combined</option>
            </select>
            
            <div className="range-indicator">
              <span>0</span>
              <div className="gradient-bar"></div>
              <span>{getMaxValue(data)}</span>
            </div>
          </div>
          <div className="months-grid">
            {Array.from({ length: 12 }, (_, monthIndex) => (
              <div key={monthIndex} className="month">
                <div className="month-label">
                  {monthNames[monthIndex]}
                </div>
                
                <div className="weekdays-grid">
                  {weekDays.map((day, i) => (
                    <div key={i} className="weekday-label">
                      {day}
                    </div>
                  ))}
                </div>
                
                <div className="days-grid">
                  {Array.from({ length: new Date(2024, monthIndex, 1).getDay() }, (_, i) => (
                    <div key={`empty-${i}`} className="day-square" />
                  ))}
                  
                  {Array.from(
                    { length: new Date(2024, monthIndex + 1, 0).getDate() },
                    (_, i) => {
                      const date = new Date(2024, monthIndex, i + 1);
                      const dateStr = date.toISOString().split('T')[0];
                      const dayData = getDayData(dateStr);
                      const intensity = dayData ? getIntensity(dayData.launched) : 0;
                      
                      return (
                        <div
                          key={i}
                          className="day-square"
                          title={dayData ? `${dayData.launched} missiles` : 'No data'}
                        >
                          <div 
                            className="day-content"
                            style={{
                              backgroundColor: intensity > 0 
                                ? `rgba(220, 38, 38, ${intensity / 100})`
                                : '#f5f5f5'
                            }}
                          />
                        </div>
                      );
                    }
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('missile-calendar'));
    root.render(<CalendarHeatmap />);
  </script>
</body>
</html>
