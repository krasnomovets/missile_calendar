<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Missile Attack Calendar</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.8/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    .calendar-container {
      max-width: 600px;
      margin: 0 auto;
      background-color: #ffffff;
      padding: 16px;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      padding: 10px;
    }

    .filter-select {
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      background: white;
    }

    .range-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #666;
    }

    .gradient-bar {
      width: 100px;
      height: 8px;
      background: linear-gradient(to right, #fff5f5, #dc2626);
      border-radius: 4px;
    }

    .year-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin: 16px 0;
    }

    .year-button {
      background: none;
      border: none;
      font-size: 20px;
      color: #666;
      cursor: pointer;
      padding: 4px 8px;
    }

    .year-button:hover {
      color: #333;
    }

    .year-display {
      font-size: 18px;
      font-weight: 500;
      color: #333;
    }

    .months-grid {
      display: grid;
      gap: 32px;
      grid-template-columns: repeat(4, 1fr);
    }

    @media (max-width: 400px) {
      .months-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
      }
    }

    .month {
      display: flex;
      flex-direction: column;
    }

    .month-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
    }

    .weekdays-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      margin-bottom: 6px;
    }

    .weekday-label {
      font-size: 10px;
      color: #999;
      text-align: center;
    }

    .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .day-square {
      aspect-ratio: 1;
      position: relative;
    }

    .day-content {
      width: 100%;
      height: 100%;
      background-color: #f5f5f5;
      transition: all 0.2s ease;
    }

    .day-content:hover {
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.3);
      transform: scale(1.1);
      z-index: 1;
    }

    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 12px;
      white-space: nowrap;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 10;
      visibility: hidden;
      opacity: 0;
      transition: all 0.2s ease;
      pointer-events: none;
    }

    .day-square:nth-child(7n) .tooltip,
    .day-square:nth-child(7n-1) .tooltip {
      left: auto;
      right: 0;
      transform: none;
    }

    .day-square:nth-child(7n-6) .tooltip,
    .day-square:nth-child(7n-5) .tooltip {
      left: 0;
      transform: none;
    }

    .tooltip-date {
      font-weight: 600;
      margin-bottom: 8px;
    }

    .day-square:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }

    .tooltip-stat {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin: 2px 0;
    }

    .calendar-footer {
      margin-top: 24px;
      border-top: 1px solid #eee;
      padding-top: 12px;
    }

    .calendar-description {
      font-size: 14px;
      line-height: 1.4;
      margin-bottom: 16px;
      color: #111;
    }

    .calendar-meta {
      font-size: 12px;
      color: #666;
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 4px 8px;
      justify-content: space-between;
      align-items: center;
    }

    .calendar-meta-label {
      color: #666;
    }

    .calendar-source {
      display: flex;
      gap: 4px;
    }

    .calendar-meta-value {
      color: #666;
    }

    .calendar-source-text {
      color: #666;
    }

    .calendar-source-link {
      color: #444;
      text-decoration: none;
    }

    .calendar-source-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="missile-calendar"></div>

  <script type="text/babel">
    const CalendarHeatmap = () => {
      const [windowWidth, setWindowWidth] = React.useState(window.innerWidth);
      const [data, setData] = React.useState(null);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [filterType, setFilterType] = React.useState('Missile');
      const [selectedYear, setSelectedYear] = React.useState(2024);

      React.useEffect(() => {
        const handleResize = () => setWindowWidth(window.innerWidth);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      React.useEffect(() => {
        const fetchData = async () => {
          try {
            setLoading(true);
            const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vREloeCErwvCs6uJ4RlQGtstC7vPd8u9qlsvE0j7a3Y83JoK7yE_5vMLx4VcdAsRQ_AVfXglj7NXU0c/pub?gid=243376231&single=true&output=csv';
            
            const response = await fetch(SHEET_URL);
            const csvText = await response.text();
            
            Papa.parse(csvText, {
              header: true,
              dynamicTyping: true,
              complete: (results) => {
                const attacks = results.data
                  .filter(row => row.date)
                  .map(row => {
                    const [month, day, year] = row.date.split('/');
                    return {
                      date: `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`,
                      type: row.attack_type,
                      launched: row.launched,
                      destroyed: row.destroyed
                    };
                  });
                
                setData(attacks);
                setLoading(false);
              },
              error: (error) => {
                throw new Error('Failed to parse CSV: ' + error.message);
              }
            });
          } catch (err) {
            setError('Failed to load data');
            setLoading(false);
          }
        };

        fetchData();
      }, []);

      if (loading) return <div>Oppdager missiler. Vennligst vent et øyeblikk...</div>;
      if (error) return <div className="error">{error}</div>;

      const getMaxValue = (filterType) => {
        const filteredData = data.filter(d => d.type === filterType);
        return Math.max(...filteredData.map(d => d.launched));
      };

      const getIntensity = (value) => {
        const maxValue = getMaxValue(filterType);
        return Math.min((value / maxValue) * 100, 100);
      };

      const monthNames = ['jan', 'feb', 'mar', 'apr', 'mai', 'jun', 
                         'jul', 'aug', 'sep', 'okt', 'nov', 'des'];
      const weekDays = ['M', 'T', 'O', 'T', 'F', 'L', 'S'];

      const formatDate = (date) => {
        return date.toLocaleDateString('no', { 
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
      };

      return (
        <div className="calendar-container">
          <div className="calendar-header">
            <select 
              value={filterType}
              onChange={(e) => setFilterType(e.target.value)}
              className="filter-select"
            >
              <option value="Missile">Missiler</option>
              <option value="Shahed">Angrepsdroner</option>
              <option value="Combined">Missiler og droner</option>
            </select>
            
            <div className="range-indicator">
              <span>0</span>
              <div className="gradient-bar"></div>
              <span>{getMaxValue(filterType)}</span>
            </div>
          </div>

          <div className="year-selector">
            <button onClick={() => setSelectedYear(y => y - 1)} className="year-button">←</button>
            <span className="year-display">{selectedYear}</span>
            <button onClick={() => setSelectedYear(y => y + 1)} className="year-button">→</button>
          </div>

          <div className="months-grid">
            {Array.from({ length: 12 }, (_, monthIndex) => (
              <div key={monthIndex} className="month">
                <div className="month-label">
                  {monthNames[monthIndex]}
                </div>
                
                <div className="weekdays-grid">
                  {weekDays.map((day, i) => (
                    <div key={i} className="weekday-label">{day}</div>
                  ))}
                </div>
                
                <div className="days-grid">
                  {Array.from({ length: new Date(selectedYear, monthIndex, 1).getDay() }, (_, i) => (
                    <div key={`empty-${i}`} className="day-square" />
                  ))}
                  
                  {Array.from(
                    { length: new Date(selectedYear, monthIndex + 1, 0).getDate() },
                    (_, i) => {
                      const date = new Date(selectedYear, monthIndex, i + 1);
                      const dateStr = date.toISOString().split('T')[0];
                      const dayData = data.find(d => d.date === dateStr && d.type === filterType);
                      const intensity = dayData ? getIntensity(dayData.launched) : 0;
                      
                      return (
                        <div key={i} className="day-square">
                          <div 
                            className="day-content"
                            style={{
                              backgroundColor: intensity > 0 
                                ? `rgba(220, 38, 38, ${Math.max(0.15, intensity / 100)})`
                                : '#f5f5f5'
                            }}
                          />
                          {dayData && (
                            <div className="tooltip">
                              <div className="tooltip-date">{formatDate(date)}</div>
                              <div className="tooltip-stat">
                                <span>Avfyrt av Russland:</span>
                                <span>{dayData.launched}</span>
                              </div>
                              <div className="tooltip-stat">
                                <span>Nedskutt av Ukraina:</span>
                                <span>{dayData.destroyed}</span>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    }
                  )}
                </div>
              </div>
            ))}
          </div>
            <div className="calendar-footer">
            <div className="calendar-description">
              Kalenderen viser russiske angrep på Ukraina fra oktober 2022 til i dag. 
              Jo mørkere fargen er, jo flere våpen ble skutt av russiske styrker mot Ukraina.
            </div>
            <div className="calendar-meta">
              <div className="calendar-meta-label">Grafikk:</div>
              <div className="calendar-meta-value">Pavlo Krasnomovets</div>
              <div className="calendar-meta-label">Kilde:</div>
              <div className="calendar-meta-value">
                Det ukrainske luftforsvaret. Data samlet av Petro Ivanjuk.
              </div>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('missile-calendar'));
    root.render(<CalendarHeatmap />);
  </script>
</body>
</html>
